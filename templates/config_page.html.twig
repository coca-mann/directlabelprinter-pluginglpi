{# plugins/directlabelprinter/templates/config_page.html.twig #}
{% import "components/form/fields_macros.html.twig" as fields %}

{% if can_edit %}
    {# Formulário principal POSTa para si mesmo #}
    <form name="config_form_directlabelprinter" action="{{ config_page_url }}" method="POST" class="glpi_form">
        {# CSRF token gerado no PHP #}
        <input type="hidden" name="_glpi_csrf_token" value="{{ csrf_token }}">

        {# --- Authentication Section --- #}
        <div class="card card-flush shadow-sm m-6">
            <div class="card-header">
                <h3 class="card-title fw-bold">{{ __('Authentication', 'directlabelprinter') }}</h3>
            </div>
            <div class="card-body">
                {{ fields.textField(
                    'api_url',
                    current_auth.api_url | default(''), {# Vem da tabela _auth agora #}
                    __('API URL', 'directlabelprinter'),
                    {'size': 60}
                ) }}

                {{ fields.textField(
                    'api_user',
                    current_auth.user | default(''), {# Vem da tabela _auth agora #}
                    __('User', 'directlabelprinter')
                ) }}

                {{ fields.passwordField(
                    'api_password',
                    null, {# Sempre vazio por segurança #}
                    __('Password', 'directlabelprinter')
                ) }}

                <div class="mt-3">
                     {# Botão com 'name' para identificar a ação no POST #}
                    <button type="submit" name="test_connection" value="1" id="test_connection_btn" class="btn btn-secondary btn-sm">{{ __('Test Connection', 'directlabelprinter') }}</button>
                    {# Span removido, feedback será via Session::addMessageAfterRedirect #}
                </div>
                {% if current_auth.access_token is defined and current_auth.access_token %}
                    <div class="alert alert-info mt-3" role="alert">
                        {{ __('Token de Acesso válido até:', 'directlabelprinter') }} {{ current_auth.access_token_expires | glpi_datetime }}
                    </div>
                {% endif %}
            </div>
        </div>

        {# --- Layouts Section --- #}
        <div class="card card-flush shadow-sm m-6">
            <div class="card-header">
                <h3 class="card-title fw-bold">{{ __('Layouts', 'directlabelprinter') }}</h3>
            </div>
            <div class="card-body">
                 {# Botão com 'name' para identificar a ação no POST #}
                <button type="submit" name="fetch_layouts" value="1" id="fetch_layouts_btn" class="btn btn-secondary btn-sm">{{ __('Fetch Layouts', 'directlabelprinter') }}</button>

                <div class="mt-4">
                    {{ fields.dropdownField(
                        'default_layout_id_api',   {# Nome do campo para o POST #}
                        layout_options,            {# Array de id_api => nome #}
                        default_layout_id_api,     {# ID da API do layout padrão atual #}
                        __('Default Layout', 'directlabelprinter')
                    ) }}
                </div>

                <h4 class="mt-5">{{ __('Layout Details', 'directlabelprinter') }}</h4>
                {% if layouts is not empty %}
                    <table class='tab_cadre_fixehov'>
                        <thead>
                            <tr>
                                <th>{{ __('Name') }}</th>
                                <th>{{ __('Description') }}</th>
                                {# ... outras colunas ... #}
                                <th>{{ __('Default', 'directlabelprinter') }}</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for layout in layouts %}
                            <tr>
                                <td>{{ layout.nome }}</td>
                                <td>{{ layout.descricao }}</td>
                                {# ... outras colunas ... #}
                                <td>{% if layout.padrao %}<i class="fas fa-check text-success"></i>{% endif %}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p>{{ __('No layouts fetched yet.', 'directlabelprinter') }}</p>
                {% endif %}
            </div>
             {# Botão Salvar para o layout padrão #}
             <div class="card-footer d-flex justify-content-end py-6 px-9">
                 <button type="submit" name="update_defaults" value="{{ _x('button', 'Save') }}" class="btn btn-primary">
                     <i class="ti ti-device-floppy me-2"></i> {{ _x('button', 'Save') }}
                 </button>
            </div>
        </div>
    </form>
{% else %}
    <p>{{ __("You don't have permission to edit this configuration.") }}</p>
{% endif %}

{# Remover o bloco <script> inline, pois não precisamos mais de AJAX aqui #}