{# plugins/directlabelprinter/templates/config_form_content.html.twig #}
{# Este template contém APENAS o formulário e a mensagem 'sem permissão' #}

{% import "components/form/fields_macros.html.twig" as fields %}
{# {% import "@directlabelprinter/_fields_macros_override.html.twig" as custom_fields %} #} {# Comentado se não usar #}

{% if can_edit %}
    {# O action agora vem do PHP ($config_page_url) #}
    <form name="config_form_directlabelprinter" action="{{ config_page_url }}" method="POST" class="glpi_form">
        {# CSRF token vem do PHP ($csrf_token) #}
        <input type="hidden" name="_glpi_csrf_token" value="{{ csrf_token }}">

        {# --- Authentication Section --- #}
        <div class="card card-flush shadow-sm m-6">
            <div class="card-header">
                <h3 class="card-title fw-bold">{{ __('Authentication', 'directlabelprinter') }}</h3>
            </div>
            <div class="card-body">
                {{ fields.textField(
                    'api_url',
                    current_auth.api_url | default(''),
                    __('API URL', 'directlabelprinter'),
                    {'size': 60}
                ) }}
                {{ fields.textField(
                    'api_user',
                    current_auth.user | default(''),
                    __('User', 'directlabelprinter')
                ) }}
                {{ fields.passwordField(
                    'api_password',
                    null,
                    __('Password', 'directlabelprinter')
                ) }}
                <div class="mt-3">
                    <button type="submit" name="test_connection" value="1" id="test_connection_btn" class="btn btn-secondary btn-sm">{{ __('Test Connection', 'directlabelprinter') }}</button>
                </div>
                 {% if current_auth.access_token is defined and current_auth.access_token %}
                    <div class="alert alert-info mt-3" role="alert">
                        {{ __('Token de Acesso válido até:', 'directlabelprinter') }} {{ current_auth.access_token_expires | glpi_datetime }}
                    </div>
                {% endif %}
            </div>
        </div>

        {# --- Layouts Section --- #}
        <div class="card card-flush shadow-sm m-6">
            <div class="card-header">
                <h3 class="card-title fw-bold">{{ __('Layouts', 'directlabelprinter') }}</h3>
            </div>
            <div class="card-body">
                <button type="submit" name="fetch_layouts" value="1" id="fetch_layouts_btn" class="btn btn-secondary btn-sm">{{ __('Fetch Layouts', 'directlabelprinter') }}</button>
                <div class="mt-4">
                     {# Usar a macro padrão 'fields', passando dados do PHP #}
                    {{ fields.dropdownField(
                        'default_layout_id_api',
                        layout_options,
                        default_layout_id_api,
                        __('Default Layout', 'directlabelprinter')
                    ) }}
                </div>
                <h4 class="mt-5">{{ __('Layout Details', 'directlabelprinter') }}</h4>
                {% if layouts is not empty %}
                    <table class='tab_cadre_fixehov'>
                        {# ... (thead e tbody da tabela, como antes) ... #}
                         <thead>
                            <tr>
                                <th>{{ __('Name') }}</th>
                                <th>{{ __('Description') }}</th>
                                <th>{{ __('Width (mm)') }}</th>
                                <th>{{ __('Height (mm)') }}</th>
                                <th>{{ __('Title Height (mm)') }}</th>
                                <th>{{ __('Title Font Size') }}</th>
                                <th>{{ __('QR Margin (mm)') }}</th>
                                <th>{{ __('Font Name') }}</th>
                                <th>{{ __('Default', 'directlabelprinter') }}</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for layout in layouts %}
                            <tr>
                                <td>{{ layout.nome }}</td>
                                <td>{{ layout.descricao }}</td>
                                <td>{{ layout.largura_mm }}</td>
                                <td>{{ layout.altura_mm }}</td>
                                <td>{{ layout.altura_titulo_mm }}</td>
                                <td>{{ layout.tamanho_fonte_titulo }}</td>
                                <td>{{ layout.margem_vertical_qr_mm }}</td>
                                <td>{{ layout.nome_fonte }}</td>
                                <td>{% if layout.padrao %}<i class="fas fa-check text-success"></i>{% endif %}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p>{{ __('No layouts fetched yet.', 'directlabelprinter') }}</p>
                {% endif %}
            </div>
            <div class="card-footer d-flex justify-content-end py-6 px-9">
                <button type="submit" name="update_defaults" value="{{ _x('button', 'Save') }}" class="btn btn-primary">
                    <i class="ti ti-device-floppy me-2"></i> {{ _x('button', 'Save') }}
                </button>
            </div>
        </div>
    </form> {# Fim do formulário #}

{% else %} {# Correspondente ao if can_edit #}
    <p>{{ __("You don't have permission to edit this configuration.") }}</p>
{% endif %} {# Fim do if can_edit #}

{# NÃO colocar JavaScript inline aqui, se precisar, usar hook ADD_JAVASCRIPT #}